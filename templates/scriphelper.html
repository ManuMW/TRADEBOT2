<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Scrip Token Helper</title>
    <link rel="stylesheet" href="/static/styles.css">
    <style>
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .back-btn {
            padding: 10px 20px;
            background: #6c757d;
            color: white;
            text-decoration: none;
            border-radius: 5px;
        }
        .back-btn:hover {
            background: #5a6268;
        }
        .form-section {
            background: white;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        .form-group label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }
        .form-group input,
        .form-group select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .btn {
            padding: 12px 24px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none;
        }
        .result-container.show {
            display: block;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
            font-style: italic;
        }
        .option-card {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            background: #f9f9f9;
            cursor: pointer;
            transition: all 0.2s;
        }
        .option-card:hover {
            border-color: #007bff;
            background: #f0f7ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,123,255,0.2);
        }
        .option-card.selected {
            border-color: #28a745;
            background: #d4edda;
        }
        .option-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .option-symbol {
            font-size: 18px;
            font-weight: bold;
            color: #007bff;
        }
        .option-token {
            background: #007bff;
            color: white;
            padding: 4px 12px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
        }
        .option-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            font-size: 14px;
        }
        .detail-item {
            display: flex;
            flex-direction: column;
        }
        .detail-label {
            color: #666;
            font-size: 12px;
            text-transform: uppercase;
        }
        .detail-value {
            font-weight: bold;
            color: #333;
            margin-top: 2px;
        }
        .success-banner {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .use-token-btn {
            background: #28a745;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }
        .use-token-btn:hover {
            background: #218838;
        }
        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #007bff;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>üîç Scrip Token Finder</h2>
            <a href="/view/optionchain" class="back-btn">‚Üê Back to Option Chain</a>
        </div>

        <div class="info-box">
            <h4>üí° How It Works</h4>
            <p>This tool searches Angel One's scrip master to find valid tokens for F&O options with the <strong>closest expiry date</strong>.</p>
            <p>Simply select the symbol, option type (CE/PE), and optionally a strike price to get active option contracts.</p>
        </div>

        <div class="form-section">
            <h3>Search for Option Tokens</h3>
            <form id="searchForm" onsubmit="searchTokens(event)">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="symbol">Symbol</label>
                        <select id="symbol" name="symbol">
                            <option value="NIFTY">NIFTY</option>
                            <option value="BANKNIFTY">BANKNIFTY</option>
                            <option value="FINNIFTY">FINNIFTY</option>
                            <option value="MIDCPNIFTY">MIDCPNIFTY</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="option_type">Option Type</label>
                        <select id="option_type" name="option_type">
                            <option value="CE">Call (CE)</option>
                            <option value="PE">Put (PE)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="strike">Strike Price (Optional)</label>
                        <input type="number" id="strike" name="strike" placeholder="e.g., 24000" step="50">
                    </div>
                </div>

                <button type="submit" class="btn">üîé Find Tokens</button>
            </form>
        </div>

        <div id="resultContainer" class="result-container">
            <div id="resultContent"></div>
        </div>
    </div>

    <script>
        let selectedToken = null;

        function searchTokens(event) {
            event.preventDefault();

            const symbol = document.getElementById('symbol').value;
            const option_type = document.getElementById('option_type').value;
            const strike = document.getElementById('strike').value;

            const resultContainer = document.getElementById('resultContainer');
            const resultContent = document.getElementById('resultContent');

            resultContainer.classList.add('show');
            resultContent.innerHTML = '<div class="loading">üîÑ Fetching scrip master and searching for tokens...</div>';

            document.querySelector('.btn').disabled = true;

            const payload = {
                symbol: symbol,
                option_type: option_type
            };

            if (strike) payload.strike = parseFloat(strike);

            fetch('/api/scrip/search', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(r => r.json())
            .then(data => {
                if (data.status && data.data) {
                    displayResults(data);
                } else {
                    resultContent.innerHTML = `<div style="color: #721c24; background: #f8d7da; padding: 15px; border-radius: 5px;">
                        ‚ùå ${data.message || 'No results found'}
                    </div>`;
                }
                document.querySelector('.btn').disabled = false;
            })
            .catch(e => {
                resultContent.innerHTML = `<div style="color: #721c24; background: #f8d7da; padding: 15px; border-radius: 5px;">
                    ‚ùå Error: ${e.message}
                </div>`;
                document.querySelector('.btn').disabled = false;
            });
        }

        function displayResults(data) {
            const resultContent = document.getElementById('resultContent');
            
            let html = `
                <div class="success-banner">
                    ‚úÖ Found ${data.data.length} option(s) for <strong>${data.closest_expiry}</strong> expiry (${data.days_to_expiry} days away)
                    <br><small>Total options available: ${data.total_options_found} | Strike range: ‚Çπ${data.strike_range.min.toLocaleString()} - ‚Çπ${data.strike_range.max.toLocaleString()}</small>
                    <br><small>Available expiries: ${data.available_expiries.join(', ')}</small>
                    ${data.cached_strikes ? `<br><strong style="color: #28a745;">‚ö° Cached strikes for speed trading: ${data.cached_strikes.map(s => '‚Çπ' + s.toLocaleString()).join(', ')}</strong>` : ''}
                </div>
            `;

            data.data.forEach((opt, index) => {
                html += `
                    <div class="option-card" onclick="selectToken('${opt.token}', ${index})">
                        <div class="option-header">
                            <span class="option-symbol">${opt.symbol}</span>
                            <span class="option-token">${opt.token}</span>
                        </div>
                        <div class="option-details">
                            <div class="detail-item">
                                <span class="detail-label">Strike Price</span>
                                <span class="detail-value">‚Çπ${parseFloat(opt.strike).toLocaleString()}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Expiry</span>
                                <span class="detail-value">${opt.expiry}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Lot Size</span>
                                <span class="detail-value">${opt.lotsize}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Type</span>
                                <span class="detail-value">${opt.option_type}</span>
                            </div>
                        </div>
                        <button class="use-token-btn" onclick="useToken('${opt.token}', event)">
                            üìã Use This Token
                        </button>
                    </div>
                `;
            });

            resultContent.innerHTML = html;
        }

        function selectToken(token, index) {
            // Remove previous selection
            document.querySelectorAll('.option-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Add selection to clicked card
            document.querySelectorAll('.option-card')[index].classList.add('selected');
            selectedToken = token;
        }

        function useToken(token, event) {
            event.stopPropagation();
            
            // Store token in sessionStorage
            sessionStorage.setItem('selected_token', token);
            
            // Show confirmation
            alert(`Token ${token} selected! Redirecting to Option Chain page...`);
            
            // Redirect to option chain page
            window.location.href = '/view/optionchain';
        }

        // On option chain page, check if token was selected
        if (window.location.pathname === '/view/optionchain') {
            const storedToken = sessionStorage.getItem('selected_token');
            if (storedToken) {
                // Auto-fill the token field
                window.addEventListener('DOMContentLoaded', () => {
                    const tokenField = document.getElementById('symboltoken');
                    if (tokenField) {
                        tokenField.value = storedToken;
                        sessionStorage.removeItem('selected_token');
                    }
                });
            }
        }
    </script>
</body>
</html>
